/**
 * ‰∏ªÈ°µÂÜÖÂÆπÁªÑ‰ª∂
 * ÂäüËÉΩÔºöÊòæÁ§∫‰∏ªÈ°µÁõ∏ÂÖ≥ÁöÑÂÜÖÂÆπÂíåÂäüËÉΩ
 * Áî®ÈÄîÔºöÂú®HomeÈ°µÈù¢‰∏≠‰Ωú‰∏∫‰∏ªÈ°µÂÜÖÂÆπÊòæÁ§∫
 * ÈõÜÊàê Omni-UI ÁªÑ‰ª∂
 */

import { OmniThemeManager, OmniThemeType, ExtendedOmniThemeStyle } from '../../utils/OmniThemeManager'
import { OmniSearchV2, OmniTag, TagItemInfo, TagMode } from '@wuba58/omni-ui'
// ÂØºÂÖ• IBest-UI ÁªÑ‰ª∂
import { IBestButton, IBestTag, IBestIcon } from '@ibestservices/ibest-ui'

@Component
export struct HomeContent {
  private omniThemeManager = OmniThemeManager.getInstance()
  @State searchText: string = ''
  @State selectedTags: string[] = ['ÁÉ≠Èó®', 'Êé®Ëçê']
  @State currentThemeType: OmniThemeType = OmniThemeType.BLUE  // ÂΩìÂâç‰∏ªÈ¢òÁ±ªÂûãÁä∂ÊÄÅ
  @State themeChangeFlag: number = 0  // ‰∏ªÈ¢òÂèòÂåñÊ†áÂøóÁä∂ÊÄÅ
  private themeChangeCallback?: (theme: OmniThemeType) => void  // ‰øùÂ≠òÂõûË∞ÉÂºïÁî®
  
  // Ê†áÁ≠æÊï∞ÊçÆ
  @State tagData: TagItemInfo[] = [
    new TagItemInfo({ title: 'ÁÉ≠Èó®', isSelected: true }),
    new TagItemInfo({ title: 'Êé®Ëçê', isSelected: true }),
    new TagItemInfo({ title: 'ÊúÄÊñ∞', isSelected: false }),
    new TagItemInfo({ title: 'Á≤æÈÄâ', isSelected: false })
  ]

  // ÁªÑ‰ª∂ÂàùÂßãÂåñÊó∂ËÆæÁΩÆ‰∏ªÈ¢òÁä∂ÊÄÅ
  aboutToAppear() {
    this.currentThemeType = this.omniThemeManager.getCurrentThemeType()
    this.themeChangeFlag = this.omniThemeManager.getThemeChangeFlag()
    
    // ÂàõÂª∫Âπ∂‰øùÂ≠ò‰∏ªÈ¢òÂèòÂåñÂõûË∞É
    this.themeChangeCallback = (theme: OmniThemeType) => {
      this.currentThemeType = theme
      this.themeChangeFlag = this.omniThemeManager.getThemeChangeFlag()
    }
    
    // Ê≥®ÂÜå‰∏ªÈ¢òÂèòÂåñÂõûË∞É
    this.omniThemeManager.addThemeChangeCallback(this.themeChangeCallback)
  }

  // ÁªÑ‰ª∂Êõ¥Êñ∞Êó∂Ê£ÄÊü•‰∏ªÈ¢òÂèòÂåñÊ†áÂøó
  aboutToUpdate() {
    const latestFlag = this.omniThemeManager.getThemeChangeFlag()
    if (this.themeChangeFlag !== latestFlag) {
      this.themeChangeFlag = latestFlag
      this.currentThemeType = this.omniThemeManager.getCurrentThemeType()
    }
  }

  // ÁªÑ‰ª∂ÈîÄÊØÅÊó∂ÁßªÈô§ÂõûË∞É
  aboutToDisappear() {
    // ÁßªÈô§‰∏ªÈ¢òÂèòÂåñÂõûË∞É
    if (this.themeChangeCallback) {
      this.omniThemeManager.removeThemeChangeCallback(this.themeChangeCallback)
    }
  }

  // Ëé∑ÂèñÂΩìÂâç‰∏ªÈ¢òÈÖçÁΩÆÁöÑÊñπÊ≥ï
  getCurrentTheme(): ExtendedOmniThemeStyle {
    return this.omniThemeManager.getCurrentTheme()
  }
  
  build() {
    Scroll() {
      Column() {
        // ‰∏ªÈ°µÊ†áÈ¢ò
        Text('Ê¨¢ËøéÂõûÊù•ÔºÅ')
          .fontSize(this.getCurrentTheme().fontSizeXl)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getCurrentTheme().textColor)
          .margin({ top: 20, bottom: 20 })
        
        // ÊêúÁ¥¢Âå∫Âüü
        Column() {
          Text('ÊêúÁ¥¢ÂäüËÉΩ')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.getCurrentTheme().textColor)
            .margin({ bottom: 10 })
          
          OmniSearchV2({
            submitCallback: (text: string) => {
              this.searchText = text
              console.log('ÊêúÁ¥¢ÂÜÖÂÆπ:', text)
            }
          })
          .width('100%')
          .height(40)
        }
        .width('100%')
        .padding(20)
        .backgroundColor(this.getCurrentTheme().surfaceColor)
        .borderRadius(12)
        .margin({ bottom: 20 })
        
        // Ê†áÁ≠æÂå∫Âüü
        Column() {
          Text('ÁÉ≠Èó®Ê†áÁ≠æ')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.getCurrentTheme().textColor)
            .margin({ bottom: 15 })
          
          OmniTag({
            tagItems: this.tagData,
            mode: TagMode.FLEX,
            selectable: true,
            onItemClick: (tagItemInfo: TagItemInfo, index: number) => {
              // ÂàáÊç¢ÈÄâ‰∏≠Áä∂ÊÄÅ
              tagItemInfo.isSelected = !tagItemInfo.isSelected
              console.log('ÈÄâ‰∏≠Ê†áÁ≠æ:', tagItemInfo.title, tagItemInfo.isSelected)
            }
          })
          .width('100%')
        }
        .width('100%')
        .padding(20)
        .backgroundColor(this.getCurrentTheme().surfaceColor)
        .borderRadius(12)
        .margin({ bottom: 20 })
        
        // Êï∞ÊçÆË°®Ê†ºÂå∫Âüü
        Column() {
          Text('ÂÆûÊó∂Êï∞ÊçÆ')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.getCurrentTheme().textColor)
            .margin({ bottom: 15 })
          
          // ‰ª™Ë°®ÊùøÂ∞èÁªÑ‰ª∂ - Â∏¶Âä®ÊÄÅÊ≥¢ÂΩ¢Âõæ
          Row() {
            // Êï∞ÊçÆ1 - ÂÆ¢ÊµÅÈáè
            Column() {
              Text('15')
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor(this.getCurrentTheme().primary)
                .margin({ bottom: 8 })
              
              Divider()
                .color(this.getCurrentTheme().borderColor)
                .strokeWidth(1)
                .margin({ bottom: 8 })
              
              // Ê®°ÊãüÊ≥¢ÂΩ¢Âõæ
              Row() {
                ForEach([1, 3, 2, 4, 3, 5, 2, 3, 4, 2], (item: number, index: number) => {
                  Rect()
                    .width(3)
                    .height(item * 2)
                    .fill(this.getCurrentTheme().primary)
                    .margin({ right: 1 })
                    .animation({
                      duration: 800,
                      curve: Curve.EaseInOut,
                      iterations: -1,
                      playMode: PlayMode.Alternate,
                      delay: index * 50
                    })
                })
              }
              .height(20)
              .justifyContent(FlexAlign.End)
              .alignItems(VerticalAlign.Bottom)
              
              Text('‰∏ÄÂ∞èÊó∂ÂÆ¢ÊµÅÈáè')
                .fontSize(10)
                .fontColor(this.getCurrentTheme().subTextColor)
                .textAlign(TextAlign.Center)
                .margin({ top: 4 })
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Center)
            .padding(12)
            .border({ width: { right: 1 }, color: this.getCurrentTheme().borderColor })
            
            // Êï∞ÊçÆ2 - Âú®Á∫øÊï∞
            Column() {
              Text('8')
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor(this.getCurrentTheme().primary)
                .margin({ bottom: 8 })
              
              Divider()
                .color(this.getCurrentTheme().borderColor)
                .strokeWidth(1)
                .margin({ bottom: 8 })
              
              // Ê®°ÊãüÊ≥¢ÂΩ¢Âõæ
              Row() {
                ForEach([2, 4, 3, 5, 4, 6, 3, 4, 5, 3], (item: number, index: number) => {
                  Rect()
                    .width(3)
                    .height(item * 2)
                    .fill(this.getCurrentTheme().primary)
                    .margin({ right: 1 })
                    .animation({
                      duration: 900,
                      curve: Curve.EaseInOut,
                      iterations: -1,
                      playMode: PlayMode.Alternate,
                      delay: index * 60
                    })
                })
              }
              .height(20)
              .justifyContent(FlexAlign.End)
              .alignItems(VerticalAlign.Bottom)
              
              Text('ÂΩìÂâçÂú®Á∫ø')
                .fontSize(10)
                .fontColor(this.getCurrentTheme().subTextColor)
                .textAlign(TextAlign.Center)
                .margin({ top: 4 })
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Center)
            .padding(12)
            .border({ width: { right: 1 }, color: this.getCurrentTheme().borderColor })
            
            // Êï∞ÊçÆ3 - ËÆøÈóÆÈáè
            Column() {
              Text('234')
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor(this.getCurrentTheme().primary)
                .margin({ bottom: 8 })
              
              Divider()
                .color(this.getCurrentTheme().borderColor)
                .strokeWidth(1)
                .margin({ bottom: 8 })
              
              // Ê®°ÊãüÊ≥¢ÂΩ¢Âõæ
              Row() {
                ForEach([3, 5, 4, 6, 5, 7, 4, 5, 6, 4], (item: number, index: number) => {
                  Rect()
                    .width(3)
                    .height(item * 2)
                    .fill(this.getCurrentTheme().primary)
                    .margin({ right: 1 })
                    .animation({
                      duration: 1000,
                      curve: Curve.EaseInOut,
                      iterations: -1,
                      playMode: PlayMode.Alternate,
                      delay: index * 70
                    })
                })
              }
              .height(20)
              .justifyContent(FlexAlign.End)
              .alignItems(VerticalAlign.Bottom)
              
              Text('‰ªäÊó•ËÆøÈóÆ')
                .fontSize(10)
                .fontColor(this.getCurrentTheme().subTextColor)
                .textAlign(TextAlign.Center)
                .margin({ top: 4 })
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Center)
            .padding(12)
            .border({ width: { right: 1 }, color: this.getCurrentTheme().borderColor })
            
            // Êï∞ÊçÆ4 - ËÆæÂ§áÁä∂ÊÄÅ
            Column() {
              Text('12')
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor(this.getCurrentTheme().primary)
                .margin({ bottom: 8 })
              
              Divider()
                .color(this.getCurrentTheme().borderColor)
                .strokeWidth(1)
                .margin({ bottom: 8 })
              
              // Ê®°ÊãüÊ≥¢ÂΩ¢Âõæ
              Row() {
                ForEach([1, 2, 3, 2, 4, 3, 2, 3, 2, 1], (item: number, index: number) => {
                  Rect()
                    .width(3)
                    .height(item * 2)
                    .fill(this.getCurrentTheme().primary)
                    .margin({ right: 1 })
                    .animation({
                      duration: 1100,
                      curve: Curve.EaseInOut,
                      iterations: -1,
                      playMode: PlayMode.Alternate,
                      delay: index * 80
                    })
                })
              }
              .height(20)
              .justifyContent(FlexAlign.End)
              .alignItems(VerticalAlign.Bottom)
              
              Text('ËÆæÂ§áÁä∂ÊÄÅ')
                .fontSize(10)
                .fontColor(this.getCurrentTheme().subTextColor)
                .textAlign(TextAlign.Center)
                .margin({ top: 4 })
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Center)
            .padding(12)
          }
          .width('100%')
          .backgroundColor(this.getCurrentTheme().surfaceColor)
          .border({ width: 1, color: this.getCurrentTheme().borderColor })
          .borderRadius(8)
        }
        .width('100%')
        .padding(20)
        .backgroundColor(this.getCurrentTheme().surfaceColor)
        .borderRadius(12)
        .margin({ bottom: 20 })
        
        // Âø´Êç∑Êìç‰ΩúÂå∫Âüü
        Column() {
          Text('Âø´Êç∑Êìç‰Ωú')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.getCurrentTheme().textColor)
            .margin({ bottom: 15 })
          
          Row() {
            Column() {
              Text('üìä')
                .fontSize(32)
                .margin({ bottom: 8 })
              Text('Êï∞ÊçÆÁªüËÆ°')
                .fontSize(14)
                .fontColor(this.getCurrentTheme().subTextColor)
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Center)
            .padding(15)
            .backgroundColor(this.getCurrentTheme().backgroundColor)
            .borderRadius(8)
            .margin({ right: 10 })
            
            Column() {
              Text('üìà')
                .fontSize(32)
                .margin({ bottom: 8 })
              Text('Ë∂ãÂäøÂàÜÊûê')
                .fontSize(14)
                .fontColor(this.getCurrentTheme().subTextColor)
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Center)
            .padding(15)
            .backgroundColor(this.getCurrentTheme().backgroundColor)
            .borderRadius(8)
            .margin({ right: 10 })
            
            Column() {
              Text('‚öôÔ∏è')
                .fontSize(32)
                .margin({ bottom: 8 })
              Text('Á≥ªÁªüËÆæÁΩÆ')
                .fontSize(14)
                .fontColor(this.getCurrentTheme().subTextColor)
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Center)
            .padding(15)
            .backgroundColor(this.getCurrentTheme().backgroundColor)
            .borderRadius(8)
          }
          .width('100%')
        }
        .width('100%')
        .padding(20)
        .backgroundColor(this.getCurrentTheme().surfaceColor)
        .borderRadius(12)
        .margin({ bottom: 20 })
      }
      .width('100%')
      .padding({ left: 20, right: 20 })
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.getCurrentTheme().backgroundColor)
  }
}
