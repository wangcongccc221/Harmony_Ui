/**
 * ä¸»é¢˜é€‰æ‹©å™¨ç»„ä»¶
 * åŠŸèƒ½ï¼šæä¾›ä¸»é¢˜é€‰æ‹©å¼¹çª—
 * ç”¨é€”ï¼šè®©ç”¨æˆ·é€‰æ‹©å½©è‰²ä¸»é¢˜
 */

import { OmniThemeManager, OmniThemeType } from '../utils/OmniThemeManager'
import { OmniUIUtils } from '../utils/OmniUIUtils'

@Component
export struct ThemeSelector {
  private omniThemeManager = OmniThemeManager.getInstance()
  private omniUIUtils = OmniUIUtils.getInstance()
  @State currentTheme: OmniThemeType = OmniThemeType.BLUE
  @State selectedTheme: OmniThemeType = OmniThemeType.BLUE  // ç”¨æˆ·é€‰æ‹©çš„ä¸»é¢˜ï¼ˆæœªç¡®è®¤ï¼‰
  onThemeSelected?: (theme: OmniThemeType) => void
  onCancel?: () => void

  // åˆå§‹åŒ–å½“å‰ä¸»é¢˜
  aboutToAppear() {
    this.currentTheme = this.omniThemeManager.getCurrentThemeType()
    this.selectedTheme = this.currentTheme  // åˆå§‹é€‰æ‹©å½“å‰ä¸»é¢˜
  }

  // é€‰æ‹©ä¸»é¢˜ï¼ˆé¢„è§ˆï¼Œä¸ç«‹å³åº”ç”¨ï¼‰
  selectTheme(theme: OmniThemeType) {
    this.selectedTheme = theme
  }

  // ç¡®è®¤åº”ç”¨ä¸»é¢˜
  confirmTheme() {
    this.currentTheme = this.selectedTheme
    if (this.onThemeSelected) {
      this.onThemeSelected(this.selectedTheme)
    }
  }

  // å–æ¶ˆé€‰æ‹©
  cancel() {
    if (this.onCancel) {
      this.onCancel()
    }
  }

  // æž„å»ºä¸»é¢˜é€‰é¡¹
  @Builder
  buildThemeOption(themeType: OmniThemeType, icon: string, title: string, description: string) {
    Row() {
      Text(icon)
        .fontSize(24)
        .margin({ right: 12 })
      
      Column() {
        Text(title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.omniThemeManager.getCurrentTheme().textColor)
        
        Text(description)
          .fontSize(12)
          .fontColor(this.omniThemeManager.getCurrentTheme().subTextColor)
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // é€‰ä¸­çŠ¶æ€æŒ‡ç¤ºå™¨
      if (this.selectedTheme === themeType) {
        Text('âœ“')
          .fontSize(20)
          .fontColor(this.omniThemeManager.getCurrentTheme().primary)
          .fontWeight(FontWeight.Bold)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(this.selectedTheme === themeType 
      ? this.omniThemeManager.getCurrentTheme().primary + '20' 
      : this.omniThemeManager.getCurrentTheme().surfaceColor)
    .borderRadius(12)
    .margin({ bottom: 12 })
    .onClick(() => {
      this.selectTheme(themeType)
    })
  }

  build() {
    // èƒŒæ™¯é®ç½©
    Column() {
      // ä¸»é¢˜é€‰æ‹©å¼¹çª—
      Column() {
        // æ ‡é¢˜
        Text('é€‰æ‹©ä¸»é¢˜')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.omniThemeManager.getCurrentTheme().textColor)
          .margin({ bottom: 20 })

        // ä¸»é¢˜é€‰é¡¹ - ä½¿ç”¨æ»šåŠ¨è§†å›¾æ”¯æŒæ›´å¤šä¸»é¢˜
        Scroll() {
          Column() {
            // å½©è‰²ä¸»é¢˜ç»„
            Text('å½©è‰²ä¸»é¢˜')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor(this.omniThemeManager.getCurrentTheme().subTextColor)
              .margin({ bottom: 8, top: 8 })
              .alignSelf(ItemAlign.Start)

            // è“è‰²ä¸»é¢˜é€‰é¡¹
            this.buildThemeOption(OmniThemeType.BLUE, 'ðŸ”µ', 'è“è‰²ä¸»é¢˜', 'çŽ°ä»£ç§‘æŠ€æ„Ÿè“è‰²ç³»')
            
            // ç»¿è‰²ä¸»é¢˜é€‰é¡¹
            this.buildThemeOption(OmniThemeType.GREEN, 'ðŸŸ¢', 'ç»¿è‰²ä¸»é¢˜', 'è‡ªç„¶æ¸…æ–°ç»¿è‰²ç³»')
            
            // ç´«è‰²ä¸»é¢˜é€‰é¡¹
            this.buildThemeOption(OmniThemeType.PURPLE, 'ðŸŸ£', 'ç´«è‰²ä¸»é¢˜', 'ä¼˜é›…ç¥žç§˜ç´«è‰²ç³»')
            
            // æ©™è‰²ä¸»é¢˜é€‰é¡¹
            this.buildThemeOption(OmniThemeType.ORANGE, 'ðŸŸ ', 'æ©™è‰²ä¸»é¢˜', 'æ´»åŠ›æ¸©æš–æ©™è‰²ç³»')
            
            // ç²‰è‰²ä¸»é¢˜é€‰é¡¹
            this.buildThemeOption(OmniThemeType.PINK, 'ðŸŒ¸', 'ç²‰è‰²ä¸»é¢˜', 'æ¸©æŸ”æµªæ¼«ç²‰è‰²ç³»')
            
            // é’è‰²ä¸»é¢˜é€‰é¡¹
            this.buildThemeOption(OmniThemeType.TEAL, 'ðŸŸ¦', 'é’è‰²ä¸»é¢˜', 'æ¸…æ–°æ·¡é›…é’è‰²ç³»')
          }
          .width('100%')
        }
        .height(400)
        .scrollable(ScrollDirection.Vertical)
        .scrollBar(BarState.Auto)
        .width('100%')

        // ç¡®è®¤å’Œå–æ¶ˆæŒ‰é’®
        Row() {
          // å–æ¶ˆæŒ‰é’®
          Button('å–æ¶ˆ')
            .layoutWeight(1)
            .height(44)
            .fontSize(16)
            .fontColor(this.omniThemeManager.getCurrentTheme().textColor)
            .backgroundColor(this.omniThemeManager.getCurrentTheme().surfaceColor)
            .border({ width: 1, color: this.omniThemeManager.getCurrentTheme().borderColor })
            .borderRadius(8)
            .margin({ top: 20, right: 8 })
            .onClick(() => {
              this.cancel()
            })

          // ç¡®è®¤æŒ‰é’®
          Button('ç¡®è®¤')
            .layoutWeight(1)
            .height(44)
            .fontSize(16)
            .fontColor('#FFFFFF')
            .backgroundColor(this.omniThemeManager.getCurrentTheme().primary)
            .borderRadius(8)
            .margin({ top: 20, left: 8 })
            .onClick(() => {
              this.confirmTheme()
            })
        }
        .width('100%')
      }
      .width('80%')
      .padding(24)
      .backgroundColor(this.omniThemeManager.getCurrentTheme().surfaceColor)
      .borderRadius(16)
      .shadow({
        radius: 20,
        color: '#00000020',
        offsetX: 0,
        offsetY: 4
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#00000060')  // åŠé€æ˜Žé»‘è‰²èƒŒæ™¯
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .onClick(() => {
      // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
      this.cancel()
    })
  }
}